---
title: <center><font size="6"><b>Detecting songs</b></font></center>
subtitle: <center><font size="4"><b>Long-billed hermit song amplitude</b></font></center>
author: <center><font size="4"><a href="http://marceloarayasalas.weebly.com/">Marcelo Araya-Salas, PhD</a> & Melanie Talavera</font></center> 
date: <center>`r format(Sys.Date(), "%d-%m-%Y")`</center>
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
fontsize: 12pt 
editor_options: 
  chunk_output_type: console
---

#### Load packages
```{r Load packages, eval = TRUE, message=FALSE, warning = FALSE}

## vector with package names
x <- c( "pbapply", "parallel", "ggplot2", "warbleR", "Rraven", "viridis", "readxl")

aa <- lapply(x, function(y) {
  
  # check if installed, if not then install 
  if (!y %in% installed.packages()[,"Package"]) 
    install.packages(y) 

  # load package
  try(require(y, character.only = T), silent = T)
})


detec_saturation <- function(X, parallel = 1, bit = 16, max_amplitude = NULL, path = NULL){
  
  if (is.null(max_amplitude))
  max_amplitude <- max((2 ^ bit) / 2) - 1
  
  out <- pblapply(1:nrow(X), cl = parallel, function(x){
    
    wv <- read_wave(X, index = x, path = path)
  
    out_df <- data.frame(sound.files = X$sound.files[x], selec = X$selec[x], prop.saturated = sum(wv@left == max_amplitude) / length(wv@left))
    
    return(out_df) 
})

 sat_df <- do.call(rbind, out)
 
 
 if (any(sat_df$prop.saturated > 0.2))
 cat(crayon::magenta(paste(sum(sat_df$prop.saturated > 0.2), "selections look saturated (i.e. > 20% of amplitude samples reached the highest value)"))) 

  if (any(all(sat_df$prop.saturated < 0.2) & any(sat_df$prop.saturated > 0.05)))
 cat(crayon::magenta(paste(sum(sat_df$prop.saturated > 0.05), "selections with some degree of saturation (i.e. < 20% but  > 5% of amplitude samples reached the highest value)"))) 

  if (all(sat_df$prop.saturated < 0.05))
 cat(crayon::silver("no saturation detected (all selections < 5% of amplitude samples reached the highest value)")) 

 
  return(sat_df)

}


```

#### Functions and parameters
```{r functions and parameters, eval = TRUE}

#functions and parameters
knitr::opts_knit$set(root.dir = normalizePath(".."))

knitr::opts_chunk$set(dpi = 50, fig.width = 12, message = FALSE, warning = FALSE, comment = FALSE) 

# ggplot2 theme
# theme_set(theme_classic(base_size = 20))

cut_path <-  "./data/raw/cuts"

treatments <- c("Calibration", "Regular_sining", "Coordination", "After_chase",  
 "Before_playback", "After_playback", "Before_interaction", "After_interaction", "Before_noise", "After_noise")

warbleR_options(wav.path = cut_path, parallel = 20)

```

```{r read raven selections, eval = TRUE}

sel_tabs <- imp_raven(path = "./data/raw/selections", warbler.format = TRUE, all.data = TRUE)

sf <- strsplit(sel_tabs$sound.files, "\\", fixed = TRUE)

sel_tabs$sound.files <- sapply(sf, function(x) x[length(x)])

warbleR_options(wl = 300, wav.path = "~/Dropbox/Recordings/LBH/", parallel = 10, flim = c(0, 11))

sel_tabs_wavs <- sel_tabs[grep("wav$", sel_tabs$sound.files, ignore.case = TRUE), ]

cs <- check_sels(sel_tabs_wavs, pb = FALSE)

sel_tabs_wavs$Treatment[grep("Coord", sel_tabs_wavs$Treatment)] <- "Coordination"
sel_tabs_wavs$Treatment[grep("BIN", sel_tabs_wavs$Treatment)] <- "Before_interaction"
sel_tabs_wavs$Treatment[grep("AIN", sel_tabs_wavs$Treatment)] <- "After_interaction"
sel_tabs_wavs$Treatment[grep("BN", sel_tabs_wavs$Treatment)] <- "Before_noise"
sel_tabs_wavs$Treatment[grep("AN", sel_tabs_wavs$Treatment)] <- "After_noise"
sel_tabs_wavs$Treatment[grep("Interaction", sel_tabs_wavs$Treatment)] <- "After_chase"
sel_tabs_wavs$Treatment[grep("BPB", sel_tabs_wavs$Treatment)] <- "Before_playback"
sel_tabs_wavs$Treatment[grep("APB", sel_tabs_wavs$Treatment)] <- "After_playback"
sel_tabs_wavs$Treatment[grep("Normal", sel_tabs_wavs$Treatment)] <- "Regular_sining"

sel_tabs_wavs$`Ind Color` <- NULL

sel_tabs_wavs$ID <- substr(sel_tabs_wavs$selec.file, 0 , 3)
sel_tabs_wavs$year <- ifelse(grepl("2021", sel_tabs_wavs$sound.files), 2021, 2019)

```

# Automatic detection of LBH songs on wav files
```{r autodetection, eval = FALSE}

song_sels <- sel_tabs_wavs[sel_tabs_wavs$Treatment != "Calibration", ]

cut_sels(song_sels, dest.path = cut_path, overwrite = FALSE)



ad <- auto_detec(threshold = 15, bp = c(1, 9), ssmooth = 300, hold.time = 0.1, output = "data.frame", path = cut_path, thinning = 0.05) 

exp_raven(X = ad, path = cut_path, sound.file.path = normalizePath(cut_path), file.name = "song_detection_sel_tabl.txt")

full_spectrograms(X = ad, sxrow = 5, rows = 13, fast.spec = TRUE, horizontal = TRUE, path = cut_path)

move_imgs(from = cut_path, to = "./data/processed/full_spectrograms_autodetec", overwrite = TRUE)

```

# Descriptive stats

- Number of recorded individuals = `r length(table(sel_tabs$ID))`

- Sound file sample size for each treatment:

```{r}

# read data
sels <- read.csv("./output/calibrated_amplitude_all_songs.csv")

sub_sels <- sel_tabs[!duplicated(sel_tabs[, c("ID", "Treatment")]), ]

agg <- aggregate(sound.files ~ Treatment, sub_sels, length)

# order levels
agg <- agg[match(treatments, agg$Treatment), ]

kable(agg)

```

- Individual sample size for each treatment:

```{r}

agg <- aggregate(sound.files ~ Treatment, sub_sels, length)

# order levels
agg <- agg[match(treatments, agg$Treatment), ]

kable(agg)

```


- Total number of songs = `r nrow(sels)`

- Mean number of songs per individual = `r round(mean(table(sels$ID)), 0)`

- Songs per treatment:
```{r}

agg <- aggregate(selec ~ Treatment, sels, length)

# order levels
agg <- agg[match(treatments[-c(1, 9, 10)], agg$Treatment), ]

kable(agg)

```

- Maximum number of saturated songs = `r max(sels$prop.saturated)`


# Measure amplitude

```{r, eval = FALSE}

sels <- imp_raven(warbler.format = TRUE, all.data = TRUE, files = "song_detection_sel_tabl.txt", path = "./data/processed", pb = FALSE)

# cs <- checksels(sels)

sel_tabs$cuts <- paste0(paste(gsub(".WAV", "", sel_tabs$sound.files, ignore.case = TRUE), sel_tabs$selec, sep = "-"), ".wav")


sels$sound.files[sels$sound.files == "424_SUR_05-Feb-2021_07.58_09.52_A41"] <- "424_SUR_05-Feb-2021_07.58_09.52_A41A"

sels <- merge(sels, sel_tabs[!duplicated(sel_tabs$cuts), c("cuts", "Treatment", "ID", "Saturation", "sound.files")], by.x = "sound.files", by.y = "cuts")

names(sels)[names(sels) == "sound.files.y"] <- "org.sound.file"

am_set <- read_excel(path = "./data/raw/audiomoth_recording_settings.xlsx")

am_set$`Original audio file` <- paste0(am_set$`Original audio file`, ".WAV")

sels <- merge(sels, am_set[, c("Raven selections file", "Audiomoth", "Gain", "Calibration", "Original audio file")], by.x = "org.sound.file", by.y = "Original audio file")


sels$duration <- sels$old.selec <- sels$View <- sels$Channel <- sels$`Begin Path` <- sels$`File Offset (s)` <- NULL

sels$cut.label <- 1

sat <- detec_saturation(sels, parallel = 10, bit = 16, path = cut_path)

sels$prop.saturated <- sat$prop.saturated


# measure uncalibrated SPL
sels$uncal.spl <- pbsapply(1:nrow(sels), cl = 20, function(x) {

  signal <- read_wave(sels, index = x, path = cut_path)
  
   # signal <- ffilter(signal, f = signal@samp.rate, from = bp[1] * 1000, to = bp[2] * 1000, bandpass = TRUE, output = "Wave")
   
  sigamp <- seewave::rms(seewave::env(signal, envt = "abs", plot = FALSE))
  signaldb <- 20 * log10(sigamp)
  
    return(signaldb)
  })


cal <- read.csv("./output/spl_constant_for_audiomoth_calibration.csv")

cal <- cal[cal$sound.files != "soundmeter", ]

cal$audiomoth <- substr(sapply(cal$sound.files, function(x) strsplit(x, split = "_")[[1]][3]), 2, 3)

cal$audiomoth[cal$audiomoth == "41"] <- "41A"

cal$gain <- sapply(cal$sound.files, function(x) strsplit(x, split = "_")[[1]][2])


sels$cal.spl <- pbsapply(1:nrow(sels), cl = 10, function(x)
  sels$uncal.spl[x] + cal$mean.diff[cal$audiomoth == sels$Audiomoth[x] & cal$gain == sels$Gain[x]]
)

write.csv(sels, "./output/calibrated_amplitude_all_songs.csv", row.names = FALSE)

```


## Session information
```{r}

sessionInfo()

```

